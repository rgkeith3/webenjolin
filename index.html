<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    class Webenjolin {
      isRunning() {
        return this.context && this.context.state == "running";
      }

      start() {
        if (!this.context) {
          this.buildBenjolin().then(() => this.monitor("filter-filter"));
        }
        this.context.resume();
      }

      stop() {
        this.context.suspend();
      }

      monitor(nodepath) {
        const nodes = nodepath.split("-");
        if (this.monitoring) {
          this.monitoring.disconnect(this.output);
        }
        let node = this.nodes;
        nodes.forEach(function(nodeName) {
          node = node[nodeName];
        });

        this.monitoring = node;
        this.monitoring.connect(this.output);
      }

      buildBenjolin() {
        this.context = new AudioContext();
        const osc1 = this.buildOscillatorSection("osc1");
        const osc2 = this.buildOscillatorSection("osc2");
        const filter = this.buildFilterSection();
        const pwmPromise = this.buildComparator();
        const runglerPromise = this.buildRungler();
        return Promise.all([pwmPromise, runglerPromise]).then(([pwm, rungler]) => {
          this.nodes = {
            osc1, osc2, filter, pwm, rungler
          };
          this.output = this.context.destination;
          this.wireItUp();
          this.attachListeners();
        });
      }

      wireItUp() {
        this.nodes.osc1.sine.connect(this.nodes.osc2.fm);
        this.nodes.osc2.sine.connect(this.nodes.osc1.fm);

        this.nodes.osc1.sine.connect(this.nodes.pwm, 0, 0);
        this.nodes.osc2.sine.connect(this.nodes.pwm, 0, 1);

        this.nodes.pwm.connect(this.nodes.filter.filter);

        this.nodes.osc1.square.connect(this.nodes.rungler, 0, 0);
        this.nodes.osc2.square.connect(this.nodes.rungler, 0, 1);
        
        this.nodes.rungler.connect(this.nodes.osc1.rungler);
        this.nodes.rungler.connect(this.nodes.osc2.rungler);
        this.nodes.rungler.connect(this.nodes.filter.rungler);
      }

      attachListeners() {
        [
          {name: "osc1", params: [this.nodes.osc1.sine, this.nodes.osc1.square]},
          {name: "osc2", params: [this.nodes.osc2.sine, this.nodes.osc2.square]},
          {name: "filter", params: [this.nodes.filter.filter]}
        ].forEach(({name, params}) => this.attachFrequencyListener(name, params));

        [
          {name: "osc1-fm", param: this.nodes.osc1.fm.gain},
          {name: "osc1-rungler", param: this.nodes.osc1.rungler.gain},
          {name: "osc2-fm", param: this.nodes.osc2.fm.gain},
          {name: "osc2-rungler", param: this.nodes.osc2.rungler.gain},
          {name: "filter-q", param: this.nodes.filter.filter.Q},
          {name: "filter-rungler", param: this.nodes.filter.rungler.gain},
          {name: "rungler-rungle", param: this.nodes.rungler.parameters.get("rungle")}
        ].forEach(({ name, param }) => {
          document.getElementById(name).oninput = (ev) => {
            param.setValueAtTime(ev.currentTarget.value, this.context.currentTime);
          }
        });

        document.querySelectorAll("input[name='filter-type']").forEach(element => {
          element.onchange = () => this.nodes.filter.filter.type = element.value;
        });

        document.querySelectorAll("input[name='monitor']").forEach(element => {
          const node = element.value;
          element.onchange = () => {this.monitor(node)}
        });

      }

      attachFrequencyListener(name, params) {
        document.getElementById(name + "-frequency").oninput = (ev) => {
          let freq = ev.currentTarget.value;
          freq = Math.pow(freq, 3);
          params.forEach((param) => {
            param.frequency.setValueAtTime(freq, this.context.currentTime);
          });

          requestAnimationFrame(() => document.querySelector("#" + name + " .hertz").innerText = freq);
        }
      }

      buildOscillatorSection(oscName) {
        const sine = this.context.createOscillator();
        const square = this.context.createOscillator();
        square.type = "square";
        const fm = this.context.createGain();
        fm.gain.value = 0;
        fm.connect(sine.frequency);
        fm.connect(square.frequency);

        const rungler = this.context.createGain();
        rungler.gain.value = 0;
        rungler.connect(sine.frequency);
        rungler.connect(square.frequency);
        
        sine.start();
        square.start();

        return { sine, square, fm, rungler };
      }

      buildFilterSection() {
        const filter = this.context.createBiquadFilter();
        filter.type = "lowpass";

        const rungler = this.context.createGain();
        rungler.gain.value = 0;
        rungler.connect(filter.frequency);

        document.querySelectorAll("input[name='filter-type']").forEach(element => {
          element.onchange = () => filter.type = element.value;
        });
        return { filter, rungler };
      }

      buildComparator() {
        return this.context.audioWorklet.addModule('comparator.js').then(() => {
          return new AudioWorkletNode(this.context, 'comparator', {numberOfInputs: 2});
        });
      }

      buildRungler() {
        return this.context.audioWorklet.addModule('rungler.js').then(() => {
          const rungler = new AudioWorkletNode(this.context, 'rungler', {numberOfInputs: 2});
          return rungler;
        });
      }
    }

    benjolin = new Webenjolin();

    onload = function() {
      document.getElementById("start").onclick = function(ev) {
        if (benjolin.isRunning()) {
          benjolin.stop();
          ev.currentTarget.innerText = "Start";
        } else {
          benjolin.start();
          ev.currentTarget.innerText = "Running!";
        }
      };
    }
  </script>
</head>
<body>
  <h1>weBenjolin</h1>
  <p>we Benjolin or Web-Benjolin?</p>
  <p>both!</p>
  <p>this is an implementation of the Benjolin synthesizer design by Rob Hordijk, based on his Blippy Box</p>
  <p>it is a chaotic noise maker that shows off many cool synthesizer techniques like:</p>
  <ol>
    <li>frequency modulation</li>
    <li>pulse waves as clock signals</li>
    <li>sequencing via shift register</li>
    <li>feedback</li>
  </ol>
  <p>this version is implemented using the WebAudio API</p>
  <p>you may hear the terrible noise it makes and think it's broken, rest assured, it is working properly :)</p>
  <p>Are You Ready?</p>
  <button type="button" id="start">Start</button>
  <div id="gui">
    <div id="osc1">
      <h3>Osc 1</h3>
      <label>Frequency: <span class="hertz">0</span>hz</label>
      <br>
      <input type="range" id="osc1-frequency" min="0" max="25" step="0.001" value="6">
      <input type="range" id="osc1-fm" min="0" max="1000" value="0">
      <input type="range" id="osc1-rungler" min="0" max="1000" value="0">
      <label>
        Sine
        <input type="radio" value="osc1-sine" name="monitor">
      </label>
      <label>
        Square
        <input type="radio" value="osc1-square" name="monitor">
      </label>
    </div>
    <div id="osc2">
      <h3>Osc 2</h3>
      <label>Frequency: <span class="hertz">0</span>hz</label>
      <br>
      <input type="range" id="osc2-frequency" min="0" max="25" step="0.001" value="5">
      <input type="range" id="osc2-fm" min="0" max="1000" value="0">
      <input type="range" id="osc2-rungler" min="0" max="1000" value="0">
      <label>
        Sine
        <input type="radio" value="osc2-sine" name="monitor">
      </label>
      <label>
        Square
        <input type="radio" value="osc2-square" name="monitor">
      </label>
    </div>
    <div id="rungler">
      <h3>Rungler</h3>
      <label>Rungle</label>
      <br>
      <input type="range" id="rungler-rungle" min="0" max="1" step="0.01">
    </div>
    <div id="filter">
      <h3>Filter</h3>
      <label>Frequency: <span class="hertz">0</span>hz</label>
      <br>
      <input type="range" id="filter-frequency" min="0" max="25" step="0.001">
      <input type="range" id="filter-q" min="0" max="25" step="0.1">
      <input type="range" id="filter-rungler" min="0" max="1000" value="0">
      <div>
        <h5>Filter Type</h5>
        <label>
          Lowpass
          <input type="radio" value="lowpass" name="filter-type" checked>
        </label>
        <label>
          Highpass
          <input type="radio" value="highpass" name="filter-type">
        </label>
        <label>
          Bandpass
          <input type="radio" value="bandpass" name="filter-type">
        </label>
      </div>
      <label>
        Filter
        <input type="radio" value="filter-filter" name="monitor">
      </label>
    </div>
    <div id="output">
      <label>
        PWM
        <input type="radio" value="pwm" name="monitor">
      </label>
    </div>
  </div>
</body>
</html>